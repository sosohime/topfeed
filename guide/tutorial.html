<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>教程 | Topfeed</title>
    <meta name="description" content="React + Koa + SSR + I18n 渐进式全栈解决方案">
    
    
    <link rel="preload" href="/topfeed/assets/css/0.styles.b830c4be.css" as="style"><link rel="preload" href="/topfeed/assets/js/app.94d7fc02.js" as="script"><link rel="preload" href="/topfeed/assets/js/21.98cbcf45.js" as="script"><link rel="prefetch" href="/topfeed/assets/js/15.58379bc7.js"><link rel="prefetch" href="/topfeed/assets/js/2.cda51ec0.js"><link rel="prefetch" href="/topfeed/assets/js/3.9f1531d6.js"><link rel="prefetch" href="/topfeed/assets/js/4.dd2239e1.js"><link rel="prefetch" href="/topfeed/assets/js/5.d513402e.js"><link rel="prefetch" href="/topfeed/assets/js/6.cf3f371f.js"><link rel="prefetch" href="/topfeed/assets/js/7.9d1d3cd6.js"><link rel="prefetch" href="/topfeed/assets/js/8.435ad142.js"><link rel="prefetch" href="/topfeed/assets/js/9.11ec9640.js"><link rel="prefetch" href="/topfeed/assets/js/10.cee86618.js"><link rel="prefetch" href="/topfeed/assets/js/11.d3769e84.js"><link rel="prefetch" href="/topfeed/assets/js/12.7570eb24.js"><link rel="prefetch" href="/topfeed/assets/js/13.3203a531.js"><link rel="prefetch" href="/topfeed/assets/js/14.ccca4259.js"><link rel="prefetch" href="/topfeed/assets/js/16.fddb4044.js"><link rel="prefetch" href="/topfeed/assets/js/17.e88031c2.js"><link rel="prefetch" href="/topfeed/assets/js/18.9f27c53a.js"><link rel="prefetch" href="/topfeed/assets/js/19.34132d5d.js"><link rel="prefetch" href="/topfeed/assets/js/20.810ba488.js"><link rel="prefetch" href="/topfeed/assets/js/22.2e53dd4c.js"><link rel="prefetch" href="/topfeed/assets/js/23.a85a108c.js"><link rel="prefetch" href="/topfeed/assets/js/24.3e8efd51.js"><link rel="prefetch" href="/topfeed/assets/js/25.b73915a4.js"><link rel="prefetch" href="/topfeed/assets/js/26.8126c527.js"><link rel="prefetch" href="/topfeed/assets/js/27.aac1f78c.js"><link rel="prefetch" href="/topfeed/assets/js/28.20b69a1b.js"><link rel="prefetch" href="/topfeed/assets/js/29.5b8b9174.js"><link rel="prefetch" href="/topfeed/assets/js/30.436bc8fb.js"><link rel="prefetch" href="/topfeed/assets/js/31.48af329f.js"><link rel="prefetch" href="/topfeed/assets/js/32.6f20662d.js">
    <link rel="stylesheet" href="/topfeed/assets/css/0.styles.b830c4be.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/topfeed/" class="home-link router-link-active"><!----> <span class="site-name">Topfeed</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/topfeed/guide/" class="nav-link router-link-active">指南</a></div><div class="nav-item"><a href="/topfeed/ssr/" class="nav-link">SSR指南</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">CLI</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topfeed/cli/" class="nav-link">CLI命令</a></li><li class="dropdown-item"><!----> <a href="/topfeed/cli/config.html" class="nav-link">CLI配置</a></li></ul></div></div><div class="nav-item"><a href="/topfeed/guide/tutorial.html" class="nav-link router-link-exact-active router-link-active">教程</a></div><div class="nav-item"><a href="https://github.com/TopFeed/topfeed" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/topfeed/guide/" class="nav-link router-link-active">指南</a></div><div class="nav-item"><a href="/topfeed/ssr/" class="nav-link">SSR指南</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">CLI</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topfeed/cli/" class="nav-link">CLI命令</a></li><li class="dropdown-item"><!----> <a href="/topfeed/cli/config.html" class="nav-link">CLI配置</a></li></ul></div></div><div class="nav-item"><a href="/topfeed/guide/tutorial.html" class="nav-link router-link-exact-active router-link-active">教程</a></div><div class="nav-item"><a href="https://github.com/TopFeed/topfeed" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>指南</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/topfeed/guide/" class="sidebar-link">安装</a></li><li><a href="/topfeed/guide/tutorial.html" class="active sidebar-link">教程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topfeed/guide/tutorial.html#模板渲染" class="sidebar-link">模板渲染</a></li><li class="sidebar-sub-header"><a href="/topfeed/guide/tutorial.html#前端渲染" class="sidebar-link">前端渲染</a></li><li class="sidebar-sub-header"><a href="/topfeed/guide/tutorial.html#服务端渲染" class="sidebar-link">服务端渲染</a></li><li class="sidebar-sub-header"><a href="/topfeed/guide/tutorial.html#spa" class="sidebar-link">SPA</a></li><li class="sidebar-sub-header"><a href="/topfeed/guide/tutorial.html#spa-ssr" class="sidebar-link">SPA + SSR</a></li></ul></li><li><a href="/topfeed/guide/structure.html" class="sidebar-link">目录结构</a></li><li><a href="/topfeed/guide/objects.html" class="sidebar-link">扩展对象</a></li><li><a href="/topfeed/guide/i18n.html" class="sidebar-link">国际化</a></li><li><a href="/topfeed/guide/ssr.html" class="sidebar-link">服务端渲染</a></li><li><a href="/topfeed/guide/cookie-and-session.html" class="sidebar-link">cookie 和 session</a></li><li><a href="/topfeed/guide/typescript.html" class="sidebar-link">Typescript 指南</a></li><li><a href="/topfeed/guide/security.html" class="sidebar-link">安全</a></li><li><a href="/topfeed/guide/middleware.html" class="sidebar-link">中间件</a></li><li><a href="/topfeed/guide/debug-and-test.html" class="sidebar-link">调试与测试</a></li><li><a href="/topfeed/guide/unit-test.html" class="sidebar-link">单元测试</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="教程"><a href="#教程" aria-hidden="true" class="header-anchor">#</a> 教程</h1> <p>通常可以通上一节的方式，使用 topfeed-init 快速新建项目, 但为了让大家更好的了解 topfeed，接下来，我们将跳过脚手架，手动一步步的搭建出一个单页 SSR 的 <a href="https://news.ycombinator.com/" target="_blank" rel="noopener noreferrer">Hacker News<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。最后的项目结果如 <a href="/topfeed/guide/structure.html">目录结构</a> 所示,最终代码地址<a href="https://github.com/TopFeed/topfeed-news" target="_blank" rel="noopener noreferrer">topfeed-news<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>;</p> <h2 id="模板渲染"><a href="#模板渲染" aria-hidden="true" class="header-anchor">#</a> 模板渲染</h2> <h3 id="初始化项目"><a href="#初始化项目" aria-hidden="true" class="header-anchor">#</a> 初始化项目</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">mkdir</span> topfeed-news
$ <span class="token function">cd</span> topfeed-news
$ <span class="token function">npm</span> init
$ <span class="token function">npm</span> i @topfeed/topfeed
$ <span class="token function">npm</span> i @topfeed/topfeed-cli
$ <span class="token function">npm</span> i -D nodemon babel-node <span class="token comment"># 用于自动重启node</span>
$ <span class="token function">mkdir</span> client server <span class="token comment"># 服务端和客户端相关代码</span>
</code></pre></div><p>添加 <code>npm scripts</code> 到 <code>package.json</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;topfeed-news&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;server:dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PORT=5555 nodemon --exec babel-node server/app.ts  --extensions '.js,.ts,.tsx'&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;client:dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;topfeed dev --target browser&quot;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="server-babel-配置"><a href="#server-babel-配置" aria-hidden="true" class="header-anchor">#</a> server Babel 配置</h3> <p>由于我们使用 typescript 进行开发，所以需进行 babel 配置,topfeed 提供了默认的 babel 配置，直接使用即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server/.babelrc.js</span>
<span class="token keyword">const</span> nodeConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@topfeed/topfeed/babel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>node<span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> nodeConfig<span class="token punctuation">;</span>
</code></pre></div><h3 id="编写-server-入口"><a href="#编写-server-入口" aria-hidden="true" class="header-anchor">#</a> 编写 Server 入口</h3> <p>我们将 server 的入口文件进行拆分,<code>server.ts</code>负责真正的 server 逻辑，而<code>app.ts</code>则是负责启动 server 的处理(process 的错误处理、信号处理等，集群模式启动等，可能存在不同的运维方式)</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// server/app.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> process <span class="token keyword">from</span> <span class="token string">&quot;process&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> startServer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">signalHandler</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;signal:&quot;</span><span class="token punctuation">,</span> signal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;SIGINT&quot;</span><span class="token punctuation">,</span> signalHandler<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;SIGINT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;SIGTERM&quot;</span><span class="token punctuation">,</span> signalHandler<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;SIGTERM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;uncaughtException&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;err:&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
	process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledRejection&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>rejection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;err&quot;</span><span class="token punctuation">,</span> rejection<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>server/server.ts</code>是真正处理业务逻辑的地方。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// server/server.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Application <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@topfeed/topfeed&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Application</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	root<span class="token punctuation">:</span> __dirname <span class="token comment">// server代码所在目录</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;start server at port:&quot;</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="编写-controller"><a href="#编写-controller" aria-hidden="true" class="header-anchor">#</a> 编写 Controller</h3> <p>如果你熟悉 Web 开发，肯定知道我们第一步需要编写的是 Controller 和 Router;</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// server/controller/homeController.ts</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;welcom to topfeed&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> main <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>配置路由映射</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// server/router/index.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Application <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@topfeed/topfeed&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> homeController <span class="token keyword">from</span> <span class="token string">&quot;controller/homeController&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>app<span class="token punctuation">:</span> Application<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> router <span class="token operator">=</span> app<span class="token punctuation">.</span>router<span class="token punctuation">;</span>
	router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/feed&quot;</span><span class="token punctuation">,</span> homeController<span class="token punctuation">.</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>此时目录结构如下</p> <div class="language-shell extra-class"><pre class="language-shell"><code>├── app.ts
├── controller
│   └── homeController.ts
├── router
│   └── index.ts
├── server.ts
├── .babelrc.js
</code></pre></div><p>好，现在可以启动来体验一下了</p> <div class="language-sh extra-class"><pre class="language-text"><code>$ npm run server:dev
$ open localhost:5555
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p> <ul><li>我们建议所有的文件都使用 ts 进行编写，模块使用 ES module 不要使用 commonjs，由于 commonjs 和 ES module 存在某些交互性问题,混用他们可能导致某些问题，常见的问题可参考<a href="https://zhuanlan.zhihu.com/p/40733281" target="_blank" rel="noopener noreferrer">深入 ES Module<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul></div> <h3 id="静态资源"><a href="#静态资源" aria-hidden="true" class="header-anchor">#</a> 静态资源</h3> <p>topfeed 内置了 static 插件，线上环境建议部署到 CDN，无需该插件。
但对于一些固定的资源文件，如 Google 的验证文件，robots 协议等。
此处把静态资源都放到 server/static 目录即可:</p> <div class="language-sh extra-class"><pre class="language-text"><code>server/static
├── robots.txt
├── sitemap.xml
</code></pre></div><h3 id="模板渲染-2"><a href="#模板渲染-2" aria-hidden="true" class="header-anchor">#</a> 模板渲染</h3> <p>绝大多数情况，我们需要读取数据后渲染模板，然后呈现给用户。故我们需要引入对应的模板引擎。
topfeed 默认集成 nunjuck 模板引擎。按如下方式启用 nunjuck 模板引擎</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// server/server.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Application<span class="token punctuation">,</span> nunjuck_view <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@topfeed/topfeed&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Application</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	root<span class="token punctuation">:</span> __dirname <span class="token comment">// server代码所在目录</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 启用nunjuck 进行模板渲染</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
	<span class="token function">nunjuck_view</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;view&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 模板所在文件夹</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;start server at port:&quot;</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为列表页编写模板文件，一般放置在<code>server/view</code>目录下</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- server/view/news/list.tpl --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Hacker News<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/public/css/news.css<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>news-view view<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      {% for item in list %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{ item.url }}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ item.title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      {% endfor %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>添加 Controller 和 Router</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// server/controller/news.ts</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">list</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> dataList <span class="token operator">=</span> <span class="token punctuation">{</span>
		list<span class="token punctuation">:</span> <span class="token punctuation">[</span>
			<span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">&quot;this is news 1&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string">&quot;/news/1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">&quot;this is news 2&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string">&quot;/news/2&quot;</span> <span class="token punctuation">}</span>
		<span class="token punctuation">]</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;news&quot;</span><span class="token punctuation">,</span> dataList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// server/router/index.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Application <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@topfeed/topfeed&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> homeController <span class="token keyword">from</span> <span class="token string">&quot;../controller/homeController&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> newsController <span class="token keyword">from</span> <span class="token string">&quot;../controller/newsController&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>app<span class="token punctuation">:</span> Application<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> router <span class="token operator">=</span> app<span class="token punctuation">.</span>router<span class="token punctuation">;</span>
	router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> homeController<span class="token punctuation">.</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>
	router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/news&quot;</span><span class="token punctuation">,</span> newsController<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="编写-service"><a href="#编写-service" aria-hidden="true" class="header-anchor">#</a> 编写 service</h3> <p>实际应用中，Controller 一般不会自己产出数据，也不会包含复杂的逻辑，复杂的过程应该抽象为业务逻辑层<code>Service</code>。
我们来添加一个 Service 抓取 <a href="https://github.com/HackerNews/API" target="_blank" rel="noopener noreferrer">Hacker News<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的数据，如下:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// server/serice/news.ts</span>
<span class="token keyword">import</span> rp <span class="token keyword">from</span> <span class="token string">&quot;request-promise&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> serverUrl <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;constants/url&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">list</span><span class="token punctuation">(</span>page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> idList<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		idList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			method<span class="token punctuation">:</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span>
			uri<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>serverUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/topstories.json`</span></span><span class="token punctuation">,</span>
			qs<span class="token punctuation">:</span> <span class="token punctuation">{</span>
				orderBy<span class="token punctuation">:</span> <span class="token string">'&quot;$key&quot;'</span><span class="token punctuation">,</span>
				startAt<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageSize <span class="token operator">*</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;`</span></span><span class="token punctuation">,</span>
				endAt<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageSize <span class="token operator">*</span> page <span class="token operator">-</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;`</span></span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			json<span class="token punctuation">:</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		idList <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// parallel GET detail</span>
	<span class="token keyword">const</span> newsList <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
		Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>idList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>serverUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/item/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>idList<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json`</span></span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> rp<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
				json<span class="token punctuation">:</span> <span class="token boolean">true</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> newsList<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>然后稍微修改下之前的 Controller:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@topfeed/topfeed&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> list <span class="token keyword">as</span> news_list <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;service/news&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">list</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>page<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> newsList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">news_list</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;news&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
		list<span class="token punctuation">:</span> newsList
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="前端渲染"><a href="#前端渲染" aria-hidden="true" class="header-anchor">#</a> 前端渲染</h2> <p>现在前后端分离已经成为主流趋势，对于复杂的页面后端渲染难以满足需求，因此我们进行前端渲染。</p> <h3 id="生成前端页面"><a href="#生成前端页面" aria-hidden="true" class="header-anchor">#</a> 生成前端页面</h3> <p>在 topfeed 中，约定的存放页面代码的文件夹是 <code>client/entry</code>,接下来我们创建第一个页面组件，新建<code>client/entry/home/index.tsx</code> 和 <code>client/entry/home/app.tsx</code> 和 <code>client/entry/home/index.scss</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// client/entry/home/app.tsx</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;./index.scss&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Welcome to Topfeed<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// client/entry/home/index.tsx</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&quot;react-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&quot;./app&quot;</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">&lt;!-- client/entry/home/index.scss -- &gt; body</span> <span class="token punctuation">{</span>
	<span class="token property">background</span><span class="token punctuation">:</span> antiquewhite<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样第一个页面就创建完成，接下来我们需要修改对应<code>home</code>的页面模板内容，此时<code>src/view/home.njk</code>不再负责实际的渲染，而只是负责渲染页面入口和加载对应的 js 和 css 资源，修改如下:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
	{{renderStyles()}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
	{{renderScripts()}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <ul><li>renderStyles: 用于注入打包的 css 文件</li> <li>renderScripts: 用于注入前端打包的 js 文件</li></ul></div> <h3 id="注入资源文件"><a href="#注入资源文件" aria-hidden="true" class="header-anchor">#</a> 注入资源文件</h3> <p>因为前端打包的 js 和 css 文件包含 hash 值，因此我们需要获取
前端打包生成文件的信息，topfeed 内置了 manifest 的插件，会生成 manifest.json 文件，为此我们需要在服务端注入 manifest 信息，以便后端渲染模板时，能注入正确的资源文件。修改<code>server/server.ts</code>如下:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// server/server.ts</span>
<span class="token keyword">import</span> manifest <span class="token keyword">from</span> <span class="token string">'public/browser/manifest.json'</span> <span class="token comment">// 获取前端生成的资源清单</span>
<span class="token operator">...</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
	<span class="token function">nunjuck_view</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		manifest<span class="token punctuation">,</span> <span class="token comment">// 注入资源清单到模板</span>
		path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'view'</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre></div><h3 id="映射页面关系"><a href="#映射页面关系" aria-hidden="true" class="header-anchor">#</a> 映射页面关系</h3> <p>完成资源文件注入和后端模板之后，我们还需要确定后端路由和前端页面的映射关系，为此修改<code>server/controller/homeController.tsx</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// server/controller/homeController.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@topfeed/topfeed&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> Context<span class="token punctuation">,</span> next<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
		<span class="token string">&quot;home&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 对应 server/view/home.njk</span>
		<span class="token punctuation">{</span>
			page<span class="token punctuation">:</span> <span class="token string">&quot;home&quot;</span> <span class="token comment">// 对应client/entry/home 页面</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> main <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="服务端渲染"><a href="#服务端渲染" aria-hidden="true" class="header-anchor">#</a> 服务端渲染</h2> <p>前端渲染可以更加方便实现复杂的业务逻辑但是对 SEO 不够友好和首屏速度较慢，而服务端渲染模板对 SEO 比较友好且首屏速度较快，但是难以适应较复杂的业务逻辑，为此结合两者，我们可以进行采用服务端渲染，
服务端渲染涉及到的知识较多，详细的服务端渲染指南请参考<a href="/topfeed/ssr/">SSR 指南</a></p> <h3 id="bundle-生成"><a href="#bundle-生成" aria-hidden="true" class="header-anchor">#</a> bundle 生成</h3> <p>服务端渲染需要分别为<code>browser</code>和<code>node</code>层生成<code>bundle</code>，以便<code>browser</code>端渲染和<code>server</code>端渲染，为此<code>topfeed</code>提供了服务端渲染的支持,修改<code>client:dev</code> scripts 如下:</p> <div class="language-json extra-class"><pre class="language-json"><code>// package.json
<span class="token punctuation">{</span>
	<span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;client:dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CONF_DEV=development topfeed dev --target ssr&quot;</span> // 此时修改 target为ssr会生成两份bundle
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="通用入口"><a href="#通用入口" aria-hidden="true" class="header-anchor">#</a> 通用入口</h3> <p>server render 和 browser render 的使用方式不一致，为此我们需要分别为 browser 和 server 编写入口文件。
为了简便，我们将两个入口统一写在<code>client/entry/index.tsx</code>里，通过</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&quot;react-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&quot;./app&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">clientRender</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	ReactDOM<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>App</span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">serverRender</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>App</span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>__BROWSER__ <span class="token operator">?</span> <span class="token function">clientRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> serverRender<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过 __BROWSER__ 区分server 和 browser入口</span>
</code></pre></div><h3 id="server-render"><a href="#server-render" aria-hidden="true" class="header-anchor">#</a> server render</h3> <p>编写完前端代码后，通过<code>npm run client:dev</code> 其会自动在<code>server/public</code>下生成<code>node</code>和<code>server</code>两个目录，其包含了<code>node</code>和<code>server</code>的两份打包 bundle，目录结构如下：</p> <div class="language-sh extra-class"><pre class="language-text"><code>├── public
│   ├── browser
│   │   ├── home.css
│   │   ├── home.css.map
│   │   ├── home.js
│   │   ├── home.js.map
│   │   ├── manifest.json
│   └── node
│       ├── feed.js
│       ├── home.css
│       └── home.js
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>对于前端 bundle，生产环境下的生成文件应该要包含 hash 值以用于更新，而服务端的代码由于存储到服务端故不需要 hash 值，而在开发环境下，为了热更新，故前端的 bundle 也没有 hash 值。</p></div> <p>生成 bundle 之后，我们就可以在<code>server/controller/homeController.tsx</code>里调用生成的 bundle 文件进行服务端渲染了。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// server/controller/homeController.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@topfeed/topfeed&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom/server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&quot;public/node/home&quot;</span><span class="token punctuation">;</span> <span class="token comment">// home页对应的bundle入口</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> Context<span class="token punctuation">,</span> next<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;home&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
			page<span class="token punctuation">:</span> <span class="token string">&quot;home&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 和 public/node/home对应</span>
			html <span class="token comment">// ssr 渲染的结果</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ctx<span class="token punctuation">.</span><span class="token keyword">throw</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 处理服务端渲染时的异常报错</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> main <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>暂时 babel-node 只支持在<code>.tsx</code>里混入<code>jsx</code>语法，因此这里我们需要在将后缀改为<code>tsx</code>。</p></div> <p>服务端渲染生成内容后，我们需要将生成的内容注入模板，修改<code>server/view/home.njk</code>如下</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
	{{renderStyles()}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 注入服务端渲染生成的内容 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{html|safe}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
	{{renderScripts()}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>服务端渲染的时候需要特别注意保证服务端渲染生成的内容和客户端首屏渲染的内容完全一致，否则会导致各种诡异的 bug，一些常见的问题如<a href="https://zhuanlan.zhihu.com/p/33887159" target="_blank" rel="noopener noreferrer">服务端渲染<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,这里一个常见的问题是</p> <div class="language-html extra-class"><pre class="language-html"><code>   <span class="token comment">&lt;!-- 正确 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{html|safe}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 错误，含有冗余的空白文本节点，会造成服务端渲染warning --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {{html|safe}}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></div> <h3 id="model"><a href="#model" aria-hidden="true" class="header-anchor">#</a> Model</h3> <p>对于稍微上规模的代码，状态管理是不可或缺的，<code>Redux</code> 是一个很好的状态管理库，但是其使用方式稍显冗杂，因此我们使用了<a href="https://github.com/rematch/rematch" target="_blank" rel="noopener noreferrer">Rematch<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>作为状态管理库，其兼容了 <code>Redux</code> 的使用方式的同时，大大简化了 <code>Redux</code> 的使用，同时对 <code>Typescript</code> 的支持也比较好。下面我们使用 <code>rematch</code> 来实现一个简化的 <code>TodoList</code>。
首先安装 rematch:</p> <div class="language-sh extra-class"><pre class="language-text"><code>npm i @rematch/core@next # 我们使用了next的某些特性，此处需要加入@next
</code></pre></div><p>创建 model，我们将 model 存放在 entry 里，里面包含三类文件</p> <ul><li><code>todo_list.tsx</code>:子 reducer，在实际应用中我们通常对 reducer 进行拆分，每个 reducer 处理各自的逻辑，最后通过 combineReducer 将各子 reducer 组合成一个 rootReducer</li> <li><code>index.tsx</code>: rootReducer, 通过 export 继承的方式<code>export * from xxx, export * from yyy</code> 将各子 reducer 进行合并。</li> <li><code>configure.tsx</code>:createStore, 负责生成最终的 store,包括集成 redux 插件等工作（SSR 情况下会做更多的工作）。</li></ul> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// entry/home/model/configure.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@rematch/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> immerPlugin <span class="token keyword">from</span> <span class="token string">&quot;@rematch/immer&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> models <span class="token keyword">from</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> models <span class="token operator">=</span> <span class="token keyword">typeof</span> models<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		models<span class="token punctuation">,</span>
		plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">immerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">// 实现immutable</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> store<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">Immutable</p> <p>因为 redux 要求 reducer 是个纯函数，这意味着我们不能修改原来的对象，而是生成原有对象的深度拷贝，手动实现深度拷贝是很烦人的(代码里充斥着...的解构操作,代码可读性也变得很差)，因此我们考虑使用 immer 来实现 Immutable，这样大大简化了状态的更新操作。</p></div> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// entry/home/models/todo_list.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createModel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@rematch/core&quot;</span><span class="token punctuation">;</span> <span class="token comment">// createModel负责根据传入的object生成对应typesript定义</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TodoItem <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typings&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> todo_list <span class="token operator">=</span> <span class="token function">createModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	state<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">as</span> TodoItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 这里as TodoItem 保证createModel能够创建正确的类型</span>
	reducers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		<span class="token comment">// 同步action</span>
		<span class="token function">add</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> TodoItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> TodoItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			state<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token keyword">delete</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> TodoItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> TodoItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> idx <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>todo <span class="token operator">===</span> payload<span class="token punctuation">.</span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				state<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> state<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function">toggle</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> TodoItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> TodoItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>todo <span class="token operator">===</span> payload<span class="token punctuation">.</span>todo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					item<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token operator">!</span>item<span class="token punctuation">.</span>done<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> state<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	effects<span class="token punctuation">:</span> <span class="token punctuation">(</span>dispatch<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
		<span class="token comment">// 异步action</span>
		<span class="token keyword">async</span> <span class="token function">delay_delete</span><span class="token punctuation">(</span>payload<span class="token punctuation">:</span> TodoItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			dispatch<span class="token punctuation">.</span>todo_list<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// client/typings/state/todo.tsx</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">TodoItem</span> <span class="token punctuation">{</span>
	todo<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
	done<span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>开发中我们发现组件需要频繁的 connect 到 redux 里，且组件频繁复用一些模型定义（如文章类型，作者类型，读者类型等），因此我们将 redux 每个 reducer 的 state 类型定义统一维护，方便使用时方便使用这些类型定义。甚至这些定义并不需要用户手动定义，通过一些工具可以根据<code>Swagger</code>和<code>Thrift</code>自动生成<code>rpc</code>和<code>http</code>接口的对应的.d.ts 定义，这样极大地便利了后期的维护和重构。</p></div> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p><code>rematch</code>的<code>model</code>对象由几个基本的属性，需要大家了解。</p> <ul><li><code>state</code>: 当前<code>model</code>状态的初始值，表示当前状态。</li> <li><code>reducer</code>: 用于处理同步操作，可以修改<code>state</code>,<code>reducer</code>是一个纯函数，接受当前<code>state</code>以及一个数据体(<code>payload</code>)作为参数，返回新的<code>state</code>。</li> <li><code>effects</code>: 用于处理异步操作和业务逻辑，返回一个 promise，入参是 dispatch，可以通过 dispatch 调用其他的 reducer 和 effects。</li></ul></div> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// entry/home/model/index.tsx</span>
<span class="token comment">/**
 * combineReducer 生成rootReducer
 * rootReducer: { todo_list: todo_list_reducer }
 **/</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;./todo_list&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>创建完 model 之后就可以在组件里使用 redux 了，我们还是使用 react-redux 来连接 redux 和组件。
创建 todo_list 组件，我们规定所有的业务组件放在<code>client/components</code>目录下。</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// client/components/todo_list.tsx</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> models <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;entry/home/models/configure&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;./index.scss&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RematchDispatch<span class="token punctuation">,</span> RematchRootState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@rematch/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AboutProps</span>
	<span class="token keyword">extends</span> <span class="token class-name">Partial</span><span class="token operator">&lt;</span>ReturnType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeof</span> <span class="token attr-name">mapState</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">&gt;,
		Partial&lt;ReturnType</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeof</span> <span class="token attr-name">mapDispatch</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">&gt; </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain-text">
class TodoList extends React.Component</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AboutProps</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> </span><span class="token punctuation">{</span>
	state <span class="token operator">=</span> <span class="token punctuation">{</span>
		todo<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token function-variable function">handleToggle</span> <span class="token operator">=</span> <span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>toggle<span class="token operator">!</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	handleChange <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token punctuation">:</span> React<span class="token punctuation">.</span>ChangeEvent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HTMLInputElement</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">) =&gt; </span><span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			todo<span class="token punctuation">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token plain-text">;
	handleDelete = (item: any) =&gt; </span><span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>delete_item<span class="token operator">!</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token plain-text">;
	handleKeyboard = (event: React.KeyboardEvent) =&gt; </span><span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>keyCode <span class="token operator">!==</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>add_item<span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			todo<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>todo<span class="token punctuation">,</span>
			done<span class="token punctuation">:</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			todo<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token plain-text">;
	render() </span><span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token punctuation">{</span> todo_items <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
		<span class="token keyword">const</span> list_dom <span class="token operator">=</span> todo_items<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>todo_item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token punctuation">(</span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todo-item<span class="token punctuation">&quot;</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>todo_item<span class="token punctuation">.</span>todo<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
						<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span>
						<span class="token attr-name">checked</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>todo_item<span class="token punctuation">.</span>done<span class="token punctuation">}</span></span>
						<span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleToggle</span><span class="token punctuation">(</span>todo_item<span class="token punctuation">)</span><span class="token punctuation">}</span></span>
					<span class="token punctuation">/&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>todo_item<span class="token punctuation">.</span>todo<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
						<span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>delete<span class="token punctuation">&quot;</span></span>
						<span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleDelete</span><span class="token punctuation">(</span>todo_item<span class="token punctuation">)</span><span class="token punctuation">}</span></span>
					<span class="token punctuation">&gt;</span></span><span class="token plain-text">
						delete
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
						<span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>delay-delete<span class="token punctuation">&quot;</span></span>
						<span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>delay_delete<span class="token operator">!</span><span class="token punctuation">(</span>todo_item <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
					<span class="token punctuation">&gt;</span></span><span class="token plain-text">
						delay_delete
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ssr-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todo-list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
						<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span>
						<span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>todo<span class="token punctuation">}</span></span>
						<span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span>
						<span class="token attr-name">onKeyDown</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleKeyboard<span class="token punctuation">}</span></span>
					<span class="token punctuation">/&gt;</span></span><span class="token plain-text">
					</span><span class="token punctuation">{</span>list_dom<span class="token punctuation">}</span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
			</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token plain-text">
}

const mapState = (</span><span class="token punctuation">{</span> todo_list <span class="token punctuation">}</span><span class="token plain-text">: RematchRootState</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>models</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">) =&gt; </span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">{</span>
		todo_items<span class="token punctuation">:</span> todo_list
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">;
const mapDispatch = (</span><span class="token punctuation">{</span> todo_list <span class="token punctuation">}</span><span class="token plain-text">: RematchDispatch</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>models</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">) =&gt; </span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">{</span>
		add_item<span class="token punctuation">:</span> todo_list<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
		toggle<span class="token punctuation">:</span> todo_list<span class="token punctuation">.</span>toggle<span class="token punctuation">,</span>
		delete_item<span class="token punctuation">:</span> todo_list<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">,</span>
		delay_delete<span class="token punctuation">:</span> todo_list<span class="token punctuation">.</span>delay_delete
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">;
export default connect(
	mapState,
	mapDispatch as any
)(TodoList);
</span></code></pre></div><h2 id="spa"><a href="#spa" aria-hidden="true" class="header-anchor">#</a> SPA</h2> <p>对于 SPA，前端和后端有着相似的分层架构，服务端和前端的分层如下图(节选自<a href="https://www.yuque.com/ant-design/course/abl3ad" target="_blank" rel="noopener noreferrer">软件分层<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)所示：
<img src="/topfeed/layer.png" alt="layer">
上图中，左侧时服务端代码的层次结构，由 Controller,Service,Data Access 三层组成服务端系统：</p> <ol><li>Controller 层负责与用户直接打交道，渲染页面、提供接口等，侧重于展示型逻辑。</li> <li>Service 层负责处理业务逻辑，供 Controller 层调用，通常是会调用 Data Access 层进行数据源操作处理。</li> <li>Data Access 层顾名思义，负责与数据源对接，进行纯粹的数据读写，供 Service 层调用。</li></ol> <p>Node 层通常有两种使用场景，</p> <ol><li>完全充当服务端，其架构和上述的服务端架构完全相同。</li> <li>充当中间层（topfeed 主要关注 node 充当中间层使用），这时候通常只有两层结构，即 Contoller 层和 Service 层，Controller 层作用和上述一样，Service 层则负责调用实际的后端调用(rpc 调用或者 http 调用),对应的后端分层实际上也被缩减为两层 Service 层和 Data Access 层。</li></ol> <p>上图的右侧是前端代码的结构，同样需要进行必要的分层：</p> <ol><li>Page 负责与用户直接打交道：渲染页面、接受用户的操作输入，侧重于展示型交互性逻辑。</li> <li>Model 负责处理业务逻辑，为 Page 做数据、状态的读写、变换、暂存等。</li> <li>Service 负责与 HTTP 接口对接，进行纯粹的数据读写。</li></ol> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>在 Node 层充当中间层和服务端渲染的场景下，Node 层和前端都有 Service 层，且其实际的工作都是负责和后端的 http 接口对接，这时候我们可以对两者的 service 层进行复用，实际上对于同构应用(Universal application)，Node 层和前端存在大量的公用逻辑(路由，数据格式化处理，数据请求等)，因此我们考虑将 client 和 server 公用的逻辑存放到 shared 目录下,最终结构是</p> <div class="language-sh extra-class"><pre class="language-text"><code>├── server server端代码
├── client client端代码
├── shared server和client公用代码
</code></pre></div></div> <h3 id="创建-page"><a href="#创建-page" aria-hidden="true" class="header-anchor">#</a> 创建 Page</h3> <p>Hacker News 的 news 分为三个子页面，Feed 页面包含了一个文章列表，Detail 页则包含了每条文章的详细信息和对应评论,User 页包含了用户的个人信息。
首先先构建三个页面。</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// client/container/news/feed</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Layout <span class="token keyword">from</span> <span class="token string">&quot;components/layout&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Article <span class="token keyword">from</span> <span class="token string">&quot;components/article&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getTopStories <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;shared/service/news&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">FeedProps</span> <span class="token punctuation">{</span>
	path<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
	page<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">FeedState</span> <span class="token punctuation">{</span>
	list<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
		title<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Feed</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token operator">&lt;</span>FeedProps<span class="token punctuation">,</span> FeedState<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
	readonly state<span class="token punctuation">:</span> FeedState <span class="token operator">=</span> <span class="token punctuation">{</span> list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">async</span> <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token punctuation">{</span> page <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
		<span class="token keyword">const</span> newsList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getTopStories</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			list<span class="token punctuation">:</span> newsList
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Layout</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>news-view view v-trnasition<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
				</span><span class="token punctuation">{</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> idx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Article</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span> <span class="token attr-name">item</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span>
				<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
			</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Layout</span><span class="token punctuation">&gt;</span></span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// client/container/news/detail</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Layout <span class="token keyword">from</span> <span class="token string">&quot;components/layout&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Article <span class="token keyword">from</span> <span class="token string">&quot;components/article&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Comment <span class="token keyword">from</span> <span class="token string">&quot;components/comment&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getItem <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;shared/service/news&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NewsItem <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typings&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">DetailProps</span> <span class="token punctuation">{</span>
	item_id<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
	path<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">DetailState</span> <span class="token punctuation">{</span>
	item<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
	comments<span class="token punctuation">:</span> NewsItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Detail</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token operator">&lt;</span>DetailProps<span class="token punctuation">,</span> DetailState<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
	state<span class="token punctuation">:</span> DetailState <span class="token operator">=</span> <span class="token punctuation">{</span>
		item<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		comments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">async</span> <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> newsInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>item_id<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> commentList <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
			newsInfo<span class="token punctuation">.</span>kids<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_id<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getItem</span><span class="token punctuation">(</span>_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;news:&quot;</span><span class="token punctuation">,</span> newsInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			item<span class="token punctuation">:</span> newsInfo<span class="token punctuation">,</span>
			comments<span class="token punctuation">:</span> commentList
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token punctuation">{</span> item<span class="token punctuation">,</span> comments <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Layout</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item-view view v-transition<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Article</span> <span class="token attr-name">item</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
					</span><span class="token punctuation">{</span>comments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
						<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>comments<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
							</span><span class="token punctuation">{</span>comments<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>comment <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Comment</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>comment<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span> <span class="token attr-name">comment</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>comment<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span>
							<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
					<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
					</span><span class="token punctuation">{</span>comments<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">No comments yet.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
			</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Layout</span><span class="token punctuation">&gt;</span></span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// client/contaner/news/user</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Layout <span class="token keyword">from</span> <span class="token string">&quot;components/layout&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Util <span class="token keyword">from</span> <span class="token string">&quot;lib/util&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IUser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typings&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getUser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;shared/service/news&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">UserState</span> <span class="token punctuation">{</span>
	user<span class="token punctuation">:</span> IUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token operator">&lt;</span>
	<span class="token punctuation">{</span>
		user_id<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
		path<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>
		user<span class="token punctuation">:</span> IUser<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
	state <span class="token operator">=</span> <span class="token punctuation">{</span>
		user<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">as</span> UserState<span class="token punctuation">;</span>
	<span class="token keyword">async</span> <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			user<span class="token punctuation">:</span> userInfo
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Layout</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>user-view view v-transition<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
							</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">user:</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> </span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
							</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">created:</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token string">&quot; &quot;</span><span class="token punctuation">}</span><span class="token plain-text">
							</span><span class="token punctuation">{</span>Util<span class="token punctuation">.</span><span class="token function">relativeTime</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>created<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
							</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">karma:</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> </span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>karma<span class="token punctuation">}</span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
							</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">about:</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
							</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>about<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>about<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>links<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token string">`https://news.ycombinator.com/submitted?id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
							submissions
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token string">`https://news.ycombinator.com/threads?id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
							comments
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
			</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Layout</span><span class="token punctuation">&gt;</span></span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="创建-service"><a href="#创建-service" aria-hidden="true" class="header-anchor">#</a> 创建 Service</h3> <p>对于 SPA，调用的 service 分为两类</p> <ol><li>服务端和客户端通用的 servcie，如首屏数据的加载所需要调用的 service，我们把这些公用的 servic 存放在 shared 目录下。</li> <li>服务端和客户端不共用的 service，如服务端的 rpc 调用，前端特有的网络请求服务等则将这些放在 client 和 server 各自的 service 里。
下面我们创建 News 所需的公用的 service</li></ol> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// shared/service/news.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> serverUrl <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../constants/url&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> http <span class="token keyword">from</span> <span class="token string">&quot;../lib/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NewsItem <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typings&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span>api<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> opts<span class="token operator">?</span><span class="token punctuation">:</span> object<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>any</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> </span><span class="token punctuation">{</span>
	<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> http<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>serverUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">
async function getTopStories(page = 1, pageSize = 10): Promise&lt;NewsItem[]&gt; </span><span class="token punctuation">{</span>
	<span class="token keyword">let</span> idList<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		idList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">&quot;topstories.json&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
			params<span class="token punctuation">:</span> <span class="token punctuation">{</span>
				page<span class="token punctuation">,</span>
				pageSize
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		idList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// parallel GET detail</span>
	<span class="token keyword">const</span> newsList <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
		idList<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>id <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>serverUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/item/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json`</span></span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> NewsItem<span class="token operator">&gt;</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> newsList<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">

async function getItem(id: number): Promise</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NewsItem</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> </span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`item/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">

async function getUser(id: number) </span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`user/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">

export </span><span class="token punctuation">{</span> getTopStories<span class="token punctuation">,</span> getItem<span class="token punctuation">,</span> getUser <span class="token punctuation">}</span><span class="token plain-text">;
</span></code></pre></div><h3 id="创建-router"><a href="#创建-router" aria-hidden="true" class="header-anchor">#</a> 创建 Router</h3> <p>对于 SPA，按需加载时必不可少的，<code>webpack</code>的<a href="https://webpack.js.org/guides/code-splitting/" target="_blank" rel="noopener noreferrer">dynamic import<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对动态按需加载提供了很好的支持，但是我们仍然需要自己处理一些超时、请求失败等情形，所幸<a href="https://github.com/jamiebuilds/react-loadable" target="_blank" rel="noopener noreferrer">react-loadable<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>封装了大部分的逻辑，同时对 SPA 的服务端也提供了很好的支持。下面我们就使用<code>react-loadable</code>和 <code>react-router</code>来定义前端路由.
首先定义路由</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// client/entry/news/routes.tsx</span>
<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">&quot;react-loadable&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Loading <span class="token keyword">from</span> <span class="token string">&quot;components/loading&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">[</span>
	<span class="token punctuation">{</span>
		name<span class="token punctuation">:</span> <span class="token string">&quot;feed&quot;</span><span class="token punctuation">,</span>
		path<span class="token punctuation">:</span> <span class="token string">&quot;/news&quot;</span><span class="token punctuation">,</span>
		component<span class="token punctuation">:</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			loader<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackPrefetch: true */</span> <span class="token string">&quot;container/news/feed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 开启prefetch优化路由切换的加载时间</span>
			delay<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
			loading<span class="token punctuation">:</span> Loading
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>
		name<span class="token punctuation">:</span> <span class="token string">&quot;detail&quot;</span><span class="token punctuation">,</span>
		path<span class="token punctuation">:</span> <span class="token string">&quot;/news/item/:item_id&quot;</span><span class="token punctuation">,</span>
		component<span class="token punctuation">:</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			loader<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackPrefetch: true */</span> <span class="token string">&quot;container/news/detail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			delay<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
			loading<span class="token punctuation">:</span> Loading
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>
		name<span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
		path<span class="token punctuation">:</span> <span class="token string">&quot;/news/user/:user_id&quot;</span><span class="token punctuation">,</span>
		component<span class="token punctuation">:</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			loader<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackPrefetch: true */</span> <span class="token string">&quot;container/news/user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			delay<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
			loading<span class="token punctuation">:</span> Loading
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>同时我们也需要修改对应的入口文件</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Routers <span class="token keyword">from</span> <span class="token string">&quot;./routes&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
	<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>news-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
				</span><span class="token punctuation">{</span>Routers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">,</span> path<span class="token punctuation">,</span> component<span class="token punctuation">:</span> Component <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Route</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span> <span class="token attr-name">path</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">component</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Component<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
			</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于使用了按需加载，为了避免加载所需组件代码时的 loading 闪烁，我们可以预先加载所需组件 react-loadble 通过 Loadable.preloadReady 可以实现组件的 preload。故修改加载入口如下:</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&quot;./app&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&quot;react-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">&quot;react-loadable&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;./index.scss&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">clientRender</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Loadable<span class="token punctuation">.</span><span class="token function">preloadReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BrowserRouter</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>App</span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
			</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>BrowserRouter</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
			document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">clientRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="spa-ssr"><a href="#spa-ssr" aria-hidden="true" class="header-anchor">#</a> SPA + SSR</h2> <p>上面的 SPA 各个页面获取首屏数据的逻辑都是存放在各页面组件的<code>componentDidMount</code>中进行的，我们能够感受到明显的页面闪烁问题，下面考虑对 SPA 实现 SSR。</p> <div class="tip custom-block"><p class="custom-block-title">React Suspense</p> <p>SPA + SSR 一个较为棘手的地方在于如何处理数据预取,详细指南参考<a href="/topfeed/ssr/data.html">数据预取和状态</a>,其复杂主要在于</p> <ol><li>保证服务端渲染时和客户端注水时获取的状态保持一致，这可以将服务端预取到的状态同步到客户端实现（涉及到 XSS 安全问题）。</li> <li>对于 SPA 用户访问一个页面分为下面两种情形：
<ul><li>用户直接浏览器输入地址访问当前页面，这样首先由服务端进行渲染，由服务端负责首屏数据的预取，然后客户端使用服务端同步的状态进行注水操作即可。</li> <li>用户在前端从 A 页面跳转到 B 页面，此时 B 页面并不经过而是直接在前端渲染，因此需要在切换路由时，进行客户端数据的预取，而客户端的预取又分为两种情况：
<ol><li>在路由导航之前完成数据的预取，使用预取数据进行渲染，这样的好处是应用代码不用处理数据获取时 loading 切换的工作，只负责数据渲染即可。</li> <li>在路由导航之后完成数据的预取，这样需要应用组件里处理数据获取时 loading 状态的切换。</li></ol></li></ul></li> <li>由于同时涉及到客户端预取和服务端预取，如何将两种预取逻辑进行统一管理，避免同时维护两份预取逻辑（通常通过 router 提供的 matchRoute 操作和页面组件的静态方法结合实现)。</li></ol> <p>由此可以看出对于单页的服务端渲染，其实现略显复杂，为了简化 SSR 的实现，React 团队提出了 Suspense，使用 Suspense 实现 SSR 可以参考<a href="https://github.com/acdlite/suspense-ssr-demo" target="_blank" rel="noopener noreferrer">Suspense<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,
相关的 Talk 和 issue</p> <ul><li><a href="https://github.com/facebook/react/issues/13206" target="_blank" rel="noopener noreferrer">React Suspense<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.youtube.com/watch?v=z-6JC0_cOns" target="_blank" rel="noopener noreferrer">React SSR Suspense<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <p>对于 SPA 的 SSR 我们配合 Redux 进行实现。
首先定义相关 models。</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// entry/news/models/index.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createModel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@rematch/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NewsState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typings&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getItem<span class="token punctuation">,</span> getTopStories<span class="token punctuation">,</span> getUser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;shared/service/news&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> news <span class="token operator">=</span> <span class="token function">createModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	state<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
		detail<span class="token punctuation">:</span> <span class="token punctuation">{</span>
			item<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			comments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		user<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token keyword">as</span> NewsState<span class="token punctuation">,</span>
	reducers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		<span class="token function">updateUser</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> NewsState<span class="token punctuation">,</span> payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			state<span class="token punctuation">.</span>user <span class="token operator">=</span> payload<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function">updateList</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> NewsState<span class="token punctuation">,</span> payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			state<span class="token punctuation">.</span>list <span class="token operator">=</span> payload<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function">updateDetail</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> NewsState<span class="token punctuation">,</span> payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			state<span class="token punctuation">.</span>detail <span class="token operator">=</span> payload<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	effects<span class="token punctuation">:</span> dispatch <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
		<span class="token comment">// 获取用户信息</span>
		<span class="token keyword">async</span> <span class="token function">loadUser</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
			dispatch<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">updateUser</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token comment">// 获取feed列表信息</span>
		<span class="token keyword">async</span> <span class="token function">loadList</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getTopStories</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
			dispatch<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">updateList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token comment">// 获取详情页信息</span>
		<span class="token keyword">async</span> <span class="token function">loadDetail</span><span class="token punctuation">(</span>item_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> newsInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getItem</span><span class="token punctuation">(</span>item_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> commentList <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
				newsInfo<span class="token punctuation">.</span>kids<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_id <span class="token operator">=&gt;</span> <span class="token function">getItem</span><span class="token punctuation">(</span>_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
			dispatch<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">updateDetail</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				item<span class="token punctuation">:</span> newsInfo<span class="token punctuation">,</span>
				comments<span class="token punctuation">:</span> commentList
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>定义好 model 之后，我们就通过 dipatch redux 的 effects 来做数据的获取逻辑，以 Detail 页面为例,修改如下,
我们在 componentDidmount 之后，dispatch redux 的 loadDetail 来获取文章的详细信息。</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// container/news/detail</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Layout <span class="token keyword">from</span> <span class="token string">&quot;components/layout&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Article <span class="token keyword">from</span> <span class="token string">&quot;components/article&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Comment <span class="token keyword">from</span> <span class="token string">&quot;components/comment&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NewsItem <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typings&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RematchDispatch<span class="token punctuation">,</span> RematchRootState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@rematch/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> models <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;entry/news/models/configure&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">DetailProps</span> <span class="token punctuation">{</span>
	item_id<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
	path<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
	item<span class="token punctuation">:</span> NewsItem<span class="token punctuation">;</span>
	comments<span class="token punctuation">:</span> NewsItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	loadDetail<span class="token punctuation">:</span> <span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>any</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">;
}
class Detail extends React.Component</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DetailProps</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> </span><span class="token punctuation">{</span>
	<span class="token keyword">async</span> <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 通过dispatch effects来初始化客户端首屏数据。</span>
		<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">loadDetail</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>item_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token punctuation">{</span> item<span class="token punctuation">,</span> comments <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Layout</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item-view view v-transition<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Article</span> <span class="token attr-name">item</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
					</span><span class="token punctuation">{</span>comments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
						<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>comments<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
							</span><span class="token punctuation">{</span>comments<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>comment <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Comment</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>comment<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span> <span class="token attr-name">comment</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>comment<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span>
							<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
						</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
					<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
					</span><span class="token punctuation">{</span>comments<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">No comments yet.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
			</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Layout</span><span class="token punctuation">&gt;</span></span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token plain-text">
const mapState = (state: RematchRootState</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>models</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">) =&gt; </span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">{</span>
		item<span class="token punctuation">:</span> state<span class="token punctuation">.</span>news<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>item<span class="token punctuation">,</span>
		comments<span class="token punctuation">:</span> state<span class="token punctuation">.</span>news<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>comments
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">;
const mapDispath = (dispatch: RematchDispatch</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>models</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">) =&gt; </span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">{</span>
		loadDetail<span class="token punctuation">:</span> dispatch<span class="token punctuation">.</span>news<span class="token punctuation">.</span>loadDetail
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">;
export default connect(
	mapState,
	mapDispath as any
)(Detail);
</span></code></pre></div><p>此时的用户首屏数据还是在 componentDidmount 内获取，我们也可以在服务端获取用户首屏数据，然后将首屏数据同步到服务端进行首屏渲染。
对于 SPA 的服务端渲染，我们即需要在服务端获取页面的首屏数据（直接输入 url 访问)，也需要在客户端获取页面的首屏数据（前端路由切换访问）。
而且两处获取首屏数据的逻辑一致，因此我们应尽可能的复用首屏数据的获取逻辑。</p> <h3 id="数据预取"><a href="#数据预取" aria-hidden="true" class="header-anchor">#</a> 数据预取</h3> <p>对于服务端数据预取，问题关键是如何根据当前的 url 获取到匹配的页面组件，进而获取该页面所需的首屏数据。
因为首屏数据和页面存在一一对应的关系，因此我们可以考虑将首屏数据挂载到页面组件上。这是<code>next.js</code>等框架的做法，如下所示</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">class</span> <span class="token class-name">Page</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
	<span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getInitialProps</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个做法的缺陷是如果我们想对页面组件使用 HOC 进行封装，需要将静态方法透传到包裹组件上，这有时在一定程度上难以实现，典型的如<code>react-loadable</code>,无法将组件透传到<code>Loadable</code>组件上。</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">&quot;detail&quot;</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> <span class="token string">&quot;/news/item/:item_id&quot;</span><span class="token punctuation">,</span>
    component<span class="token punctuation">:</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 因为是异步加载故这里难以将detail的静态方法透传到Loadable上。</span>
      loader<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackPrefetch: true */</span> <span class="token string">&quot;container/news/detail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      delay<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      loading<span class="token punctuation">:</span> Loading
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">asyncData</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dispatch <span class="token punctuation">}</span><span class="token punctuation">:</span> Store<span class="token punctuation">,</span> <span class="token punctuation">{</span> params <span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> dispatch<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">loadDetail</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>item_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>因此我们考虑将数据预取的逻辑存放在<code>routes</code>里,添加了数据预取后的<code>routes</code>如下所示。</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">[</span>
	<span class="token punctuation">{</span>
		name<span class="token punctuation">:</span> <span class="token string">&quot;detail&quot;</span><span class="token punctuation">,</span>
		path<span class="token punctuation">:</span> <span class="token string">&quot;/news/item/:item_id&quot;</span><span class="token punctuation">,</span>
		component<span class="token punctuation">:</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			loader<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackPrefetch: true */</span> <span class="token string">&quot;container/news/detail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			delay<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
			loading<span class="token punctuation">:</span> Loading
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token keyword">async</span> <span class="token function">asyncData</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dispatch <span class="token punctuation">}</span><span class="token punctuation">:</span> Store<span class="token punctuation">,</span> <span class="token punctuation">{</span> params <span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//添加数据预取逻辑</span>
			<span class="token keyword">await</span> dispatch<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">loadDetail</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>item_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>
		name<span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
		path<span class="token punctuation">:</span> <span class="token string">&quot;/news/user/:user_id&quot;</span><span class="token punctuation">,</span>
		component<span class="token punctuation">:</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			loader<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackPrefetch: true */</span> <span class="token string">&quot;container/news/user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			delay<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
			loading<span class="token punctuation">:</span> Loading
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token keyword">async</span> <span class="token function">asyncData</span><span class="token punctuation">(</span>store<span class="token punctuation">:</span> Store<span class="token punctuation">,</span> <span class="token punctuation">{</span> params <span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">await</span> store<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">loadUser</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>
		name<span class="token punctuation">:</span> <span class="token string">&quot;feed&quot;</span><span class="token punctuation">,</span>
		path<span class="token punctuation">:</span> <span class="token string">&quot;/news/feed/:page?&quot;</span><span class="token punctuation">,</span>
		component<span class="token punctuation">:</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			loader<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackPrefetch: true */</span> <span class="token string">&quot;container/news/feed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			delay<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
			loading<span class="token punctuation">:</span> Loading
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token keyword">async</span> <span class="token function">asyncData</span><span class="token punctuation">(</span>store<span class="token punctuation">:</span> Store<span class="token punctuation">,</span> <span class="token punctuation">{</span> params <span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">await</span> store<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">loadList</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="服务端数据预取"><a href="#服务端数据预取" aria-hidden="true" class="header-anchor">#</a> 服务端数据预取</h4> <p>我们这里将实际的获取数据的逻辑封装在 redux 的 effects 里，这样方便服务端和客户端统一调用。
在<code>routes</code>里定义了数据预取逻辑后，我们接下来就可以在服务端进行数据预取操作了。
我们使用<code>react-router</code>的<code>matchPath</code>来根据当前路由匹配对应页面组件，进而做数据预取操作。代码如下：</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// server/controller/newsController.ts</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">list</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> promises<span class="token punctuation">:</span> Promise<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>any</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">[] = [];
	const store = configureStore();
	routes.some((route: any) =&gt; </span><span class="token punctuation">{</span>
		<span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token function">matchPath</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>url<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 判断当前页面是否与路由匹配</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">asyncData</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> match<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token plain-text">);
	await Promise.all(promises); // 等待匹配页面的effects都派发完毕
	const context: any = </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain-text">;
	const html = renderToString(
		</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>App</span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span> <span class="token attr-name">url</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>url<span class="token punctuation">}</span></span> <span class="token attr-name">context</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>context<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
	);
	if (context.url) </span><span class="token punctuation">{</span>
		ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>status<span class="token punctuation">,</span> context<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token plain-text">
	await ctx.render(&quot;news&quot;, </span><span class="token punctuation">{</span>
		page<span class="token punctuation">:</span> <span class="token string">&quot;news&quot;</span><span class="token punctuation">,</span>
		html<span class="token punctuation">,</span>
		initial_state<span class="token punctuation">:</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 将服务端预取数据后的状态同步到客户端作为客户端的初始状态</span>
	<span class="token punctuation">}</span><span class="token plain-text">);
}
</span></code></pre></div><h3 id="客户端注水"><a href="#客户端注水" aria-hidden="true" class="header-anchor">#</a> 客户端注水</h3> <p>实现了服务端预取之后，我们需要将服务端获取的状态同步到客户端，以保证客户端渲染的结果和服务端保持一致。
客户端注水共分为三步</p> <h4 id="获取服务端完成数据预取后的-initial-state"><a href="#获取服务端完成数据预取后的-initial-state" aria-hidden="true" class="header-anchor">#</a> 获取服务端完成数据预取后的 initial_state</h4> <p>在<code>newsController</code>中可以获取服务端的 initial_state</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;news&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
	page<span class="token punctuation">:</span> <span class="token string">&quot;news&quot;</span><span class="token punctuation">,</span>
	html<span class="token punctuation">,</span>
	initial_state<span class="token punctuation">:</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 将服务端预取数据后的状态同步到客户端作为客户端的初始状态</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="将-initial-state-同步到模板上"><a href="#将-initial-state-同步到模板上" aria-hidden="true" class="header-anchor">#</a> 将 initial_state 同步到模板上</h4> <p>我们可以使用<code>renderState</code>将服务端获取的 initial_state 同步到模板上。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
	{{renderStyles()}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{html|safe}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 同步intial_state到模板 --&gt;</span>
	{{renderState()}}
	{{renderScripts()}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="客户端根据模板上的-initial-state-初始化-store"><a href="#客户端根据模板上的-initial-state-初始化-store" aria-hidden="true" class="header-anchor">#</a> 客户端根据模板上的 initial_state 初始化 store</h4> <p>configure 支持传入 intial_state 来初始化 store</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">const</span> <span class="token function-variable function">clientRender</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">configureStore</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据window.__INITIAL_STATE__初始化store</span>
	Loadable<span class="token punctuation">.</span><span class="token function">preloadReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		ReactDOM<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Provider</span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BrowserRouter</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>App</span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>BrowserRouter</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
			</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Provider</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
			document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="客户端数据预取"><a href="#客户端数据预取" aria-hidden="true" class="header-anchor">#</a> 客户端数据预取</h3> <p>受限于<code>react-router</code>并没有像<code>vue-router</code>提供类似<code>beforeRouteUpdate</code>的 api，我们只有在其他地方进行客户端预取操作，考虑如下的 hooks</p> <ol><li><code>componentDidMount</code>: 需要区分是首次渲染还是路由跳转</li> <li><code>componentWillReceiveProps</code>: react-router 切换路由是会进行 mount/unmount 操作，路由组件切换时，页面组件不会触发<code>componentWillReceiveProps</code></li> <li><code>history.listen</code>: 路由切换时触发</li></ol> <p>综上我们考虑在应用入口处通过 history.listen 里进行客户端数据预取操作。</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Switch<span class="token punctuation">,</span> Route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> withRouter<span class="token punctuation">,</span> matchPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Routers <span class="token keyword">from</span> <span class="token string">&quot;./routes&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> models <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./models/configure&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RematchDispatch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@rematch/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;./index.scss&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token operator">&lt;</span><span class="token punctuation">{</span>
	history<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
	dispatch<span class="token punctuation">:</span> RematchDispatch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>models</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">;
	location: any;
}&gt; </span><span class="token punctuation">{</span>
	unlisten<span class="token operator">!</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
	<span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token punctuation">{</span> history <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span> <span class="token comment">// 客户端的数据预取操作</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>unlisten <span class="token operator">=</span> history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>location<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> route <span class="token keyword">of</span> Routers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token function">matchPath</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">await</span> route<span class="token punctuation">.</span><span class="token function">asyncData</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dispatch<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>dispatch <span class="token punctuation">}</span><span class="token punctuation">,</span> match<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlisten</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 卸载时取消listen</span>
	<span class="token punctuation">}</span>
	<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>news-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Switch</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
					</span><span class="token punctuation">{</span>Routers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">,</span> path<span class="token punctuation">,</span> component<span class="token punctuation">:</span> Component <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Route</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span> <span class="token attr-name">path</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">component</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Component<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
				</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Switch</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
			</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token plain-text">
const mapDispatch = (dispatch: RematchDispatch</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>models</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">) =&gt; </span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">{</span>
		dispatch
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">;
// 通过withRouter来获取history
export default withRouter</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>any</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">(
	connect(
		undefined,
		mapDispatch as any
	)(App)
);
</span></code></pre></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/20/2018, 4:20:23 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/topfeed/guide/" class="prev router-link-active">
          安装
        </a></span> <span class="next"><a href="/topfeed/guide/structure.html">
          目录结构
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/topfeed/assets/js/21.98cbcf45.js" defer></script><script src="/topfeed/assets/js/app.94d7fc02.js" defer></script>
  </body>
</html>
